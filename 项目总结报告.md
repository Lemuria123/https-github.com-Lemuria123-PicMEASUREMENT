# Mark & Weld 项目技术总结报告 (v1.0)

## 1. 项目愿景与核心定位
**Mark & Weld** 是一款面向工业视觉与自动化领域的精密工具，旨在解决从“静态 CAD 设计/图片测量”到“逻辑点位生成与坐标对齐”的完整工作流。
系统当前处于 **STAGE_DESIGN (设计与测量阶段)**，具备极高的坐标投影精度与自动化特征识别能力。

---

## 2. 核心功能模块分析

### 2.1 坐标投影系统 (Precision Projection System)
这是系统的命脉。通过 `ImageCanvas.tsx` 实现了一套多级坐标转换逻辑：
- **屏幕空间 (Screen Space)**: 原始鼠标点击像素。
- **布局空间 (Layout Space)**: 基于 CSS `getComputedStyle` 获取的亚像素精度容器尺寸。
- **归一化空间 (Normalized Space)**: 映射至 `0.0 - 1.0` 的百分比坐标，确保在不同显示器和缩放倍数下数据一致。
- **物理/CAD 空间 (Logic/CAD Space)**: 通过校准数据 (`CalibrationData`) 或 DXF 原始边界计算出的实际工业坐标（单位：mm）。

### 2.2 DXF 解析与语义化识别 (DXF Intelligence)
- **矩阵转换**: 支持 `INSERT` 块的递归解析，完整处理平移、缩放、旋转转换矩阵。
- **空间索引**: 引入 `Spatial Grid Hashing` (空间网格哈希) 算法，将数万个 DXF 实体分配至网格，将匹配复杂度从 $O(n^2)$ 降低至 $O(k \cdot n)$。
- **模糊匹配引擎**: 基于锚点 (Anchor Point) 的旋转不变性匹配算法。支持几何公差、位置灵敏度及角度容差的动态调节。

### 2.3 AI 视觉特征搜索 (AI-Powered Vision)
- **模型集成**: 利用 `gemini-3-flash-preview` 进行目标检测。
- **多级处理**: 图像压缩优化 -> ROI 裁剪 -> AI 推理 -> IoU 去重抑制。
- **逻辑关联**: 将 AI 发现的视觉特征转化为可导出的坐标点位。

### 2.4 数据管理模型 (Data Fact Source)
- **useDomainData**: 系统的“唯一事实来源”，存储所有标定、实体、组件及 AI 组数据。
- **useAppLogic**: 业务中枢，协调交互逻辑与数据持久化。
- **ProjectConfig**: 标准化 JSON 配置，支持项目状态的完整回溯与二次加载。

---

## 3. 关键算法逻辑说明

### 3.1 旋转不变性匹配 (Rotation-Invariant Matching)
在 DXF 自动匹配中，系统采用“双锚点策略”：
1. **主锚点 (s0)**: 选择特征最明显的实体（如最大圆）。
2. **从锚点 (s1)**: 计算其与主锚点的距离 $D$ 和相对角度 $\theta_{ref}$。
3. **搜索逻辑**: 
   - 寻找所有符合 $s0$ 特征的候选项。
   - 在候选项周围 $D \pm \epsilon$ 范围内寻找符合 $s1$ 特征的实体。
   - 计算两者的连线角度 $\theta_{cand}$，得出旋转偏移 $\Delta\theta = \theta_{cand} - \theta_{ref}$。
   - 对其余实体进行旋转矩阵校验。

### 3.2 深度点击判定 (Refined Hit-Testing)
- **层级优先级**: `Hovered > Selected > Family Match > Standard > Background`。
- **包围盒偏差**: 引入 `hitThreshold`，随 Canvas 缩放比例动态调整，确保在高倍放大下依然能精准拾取细微线条。

---

## 4. 视觉与交互规范 (UI/UX Standards)
- **配色系统**: 采用深色工业风 (`Slate-950` 底色)，关键动作使用 `Indigo` (靛蓝) 和 `Emerald` (祖母绿) 进行语义区分。
- **响应式侧边栏**: 根据 `AppMode` 动态切换面板（测量工具、DXF 分析、AI 分析）。
- **实时看板**: 顶部展示当前光标物理坐标及悬停对象的旋转角度（Rad/Deg）。

---

## 5. 未来扩展方向 (Toward STAGE_PRODUCTION)
当前架构已为“生产调试”预留了如下扩展点：
1. **Layer-based Overlay**: 可在 `CanvasLayers.tsx` 中直接新增 `MotionLayer` 或 `RealtimeLaserLayer`。
2. **Property Expansion**: `DxfComponent` 和 `AiFeatureGroup` 的 `isWeld` / `isMark` 标签可直接关联工艺参数（功率、速度、延时）。
3. **Logic Integration**: 现有的 `getLogicCoords` 提供了直接输出至 PLC 或运动控制卡的底层数据支持。

---
*报告生成人：高级视觉与工业自动化架构师*
*生成日期：2025-05-22*

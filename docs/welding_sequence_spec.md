# Mark & Weld - 焊接工序 (Welding Sequence) 模块需求规格说明书

## 1. 模块定位
焊接工序模块属于系统的 **STAGE_PRODUCTION (生产准备阶段)**。其核心目标是为已识别的“焊点 (Weld Points)”分配生产优先级和路径顺序，并提供直观的可视化校验。

## 2. 视觉表现与环境隔离 (Visual Isolation)
为了确保操作者专注于焊接逻辑，系统在进入 `weld_sequence` 模式时需支持以下逻辑：

*   **背景层 (Background)**: 保持原始图片或 DXF 背景辅助线的可见度，但应以低对比度渲染（调暗）。
*   **元素自动过滤**: 
    *   **隐藏非焊接元素**: 自动隐藏所有未标记为 `isWeld` 的组件及其包含的 CAD 实体（如：铜箔层、机械外框线、非焊接的 Mark 点）。
    *   **隐藏未分配实体**: 未分配到任何组件的散乱 CAD 实体在工序模式下应不可见。
*   **序号标签层 (Sequence Labeling)**: 
    *   在焊点（组件重心）上方或侧方叠加渲染序号标签（例如 `S1`, `S2`）。
    *   标签背景颜色应与组件颜色一致，文字使用高对比度色（白/黑）。
    *   序号标签应随画布缩放，但保持最小可读尺寸。

## 3. 交互逻辑 (Interaction Logic)

### 3.1 悬停与检测 (Hover & Hit-Testing)
*   **近场触发 (Proximity Testing)**: 
    *   由于焊点通常较小，传统的路径边缘检测难以触发悬停。
    *   **算法**: 实现基于物理距离的碰撞检测。当光标距离焊点中心（归一化坐标转换后的屏幕坐标）在 **15px** 范围内时，自动触发该焊点的 `hoveredComponentId`。
*   **视觉反馈**: 
    *   **画布**: 悬停时，焊点显示十字准星高亮，标签放大或改变透明度。
    *   **联动**: 侧边栏列表中的对应项自动滚动到视图并进入激活状态。

### 3.2 序号录入 (Sequence Assignment)
*   **键盘直录 (Quick Entry)**: 
    *   用户光标悬停在某个焊点上时，直接按下数字键进行赋值。
*   **输入缓冲区 (500ms Buffer)**: 
    *   为了支持多位数字（如 12 号工序），系统设置 500ms 的输入缓冲区。
    *   **行为**: 快速连续按下 "1" 和 "2"，系统最终赋值 "12"。如果间隔超过 500ms，则视为将 "1" 改为 "2"。
*   **录入音效/视觉确认**: 成功录入后，标签应有一个轻微的缩放动画（Pulse）。

### 3.3 批量框选赋值 (Batch Rect-Assignment)
*   **操作流**: 
    1. 在工序面板激活一个目标工序（如 Sequence 5）。
    2. 进入 `box_rect` 模式。
    3. 在画布上拉出矩形框。
    4. 释放时，矩形内部所有的 **Weld Points** 自动加入 Sequence 5。
*   **原子性**: 框选过程中不应触碰或修改非焊接元素。

## 4. 侧边栏面板设计 (Sidebar Panel)
*   **列表组织**: 按 Sequence 数字大小排序展示。
*   **统计功能**: 实时显示每个工序包含的点位数。
*   **缺失校验**: 自动识别并标记“未分配工序”的焊点，通过警告色提示。
*   **快捷键说明**: 面板底部常驻快捷键提示（如：`Hover + Num`: Assign Sequence）。

## 5. 数据持久化 (Data Consistency)
*   **字段定义**: 在 `DxfComponent` 结构中新增 `sequence: string | number` 字段。
*   **导出支持**: CSV 导出文件必须包含 `Sequence` 列表，支持按工序顺序导出坐标，以便直接驱动激光振镜或机械臂。

---
*文档版本：v1.0*
*状态：待实现/恢复*
*编写人：Senior